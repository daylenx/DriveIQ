rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isFleetMember(fleetId) {
      return fleetId != null && 
        exists(/databases/$(database)/documents/fleets/$(fleetId)/members/$(request.auth.uid));
    }

    function isFleetAdmin(fleetId) {
      return fleetId != null && 
        exists(/databases/$(database)/documents/fleets/$(fleetId)/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/fleets/$(fleetId)/members/$(request.auth.uid)).data.role == 'admin';
    }

    function isFleetDriver(fleetId) {
      return fleetId != null && 
        exists(/databases/$(database)/documents/fleets/$(fleetId)/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/fleets/$(fleetId)/members/$(request.auth.uid)).data.role == 'driver';
    }

    function ownershipFieldsUnchanged() {
      return (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'createdBy', 'createdAt']));
    }

    function subscriptionFieldsUnchanged() {
      return (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscriptionPlan', 'subscriptionStatus', 'vehicleLimit', 'entitlements']));
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        (resource.data.fleetId != null && isFleetAdmin(resource.data.fleetId))
      );
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId) && subscriptionFieldsUnchanged();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ============================================
    // VEHICLES COLLECTION
    // ============================================
    match /vehicles/{vehicleId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetMember(resource.data.fleetId)
      );

      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && ownershipFieldsUnchanged() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId) ||
        (isFleetDriver(resource.data.fleetId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentOdometer', 'lastOdometerUpdate', 'updatedAt']))
      );

      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId)
      );
    }

    // ============================================
    // MAINTENANCE TASKS COLLECTION
    // ============================================
    match /maintenanceTasks/{taskId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetMember(resource.data.fleetId)
      );

      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && ownershipFieldsUnchanged() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId)
      );

      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId)
      );
    }

    // ============================================
    // SERVICE LOGS COLLECTION
    // ============================================
    match /serviceLogs/{logId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetMember(resource.data.fleetId)
      );

      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && ownershipFieldsUnchanged() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId)
      );

      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isFleetAdmin(resource.data.fleetId)
      );
    }

    // ============================================
    // FLEETS COLLECTION
    // ============================================
    match /fleets/{fleetId} {
      allow read: if isAuthenticated() && isFleetMember(fleetId);
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
        isFleetAdmin(fleetId) &&
        request.resource.data.createdBy == resource.data.createdBy;
      allow delete: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;

      match /members/{memberId} {
        allow read: if isAuthenticated() && isFleetMember(fleetId);
        allow create: if isAuthenticated() && (
          isFleetAdmin(fleetId) ||
          memberId == request.auth.uid
        );
        allow update: if isAuthenticated() && (
          isFleetAdmin(fleetId) ||
          (memberId == request.auth.uid && 
            !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
        );
        allow delete: if isAuthenticated() && (
          isFleetAdmin(fleetId) ||
          memberId == request.auth.uid
        );
      }
    }

    match /{path=**}/members/{memberId} {
      allow read: if isAuthenticated() && memberId == request.auth.uid;
    }

    // ============================================
    // FLEET INVITES COLLECTION
    // Fields: email, fleetId, fleetName, role, invitedAt, invitedBy
    // Query patterns:
    // 1. where('email', '==', userEmail) - invitee checks their invites
    // 2. where('fleetId', '==', fleetId) - admin views pending invites
    // ============================================
    match /fleetInvites/{inviteId} {
      // Read: inviter (fleet admin) OR invitee (matched by email)
      allow read: if isAuthenticated() && (
        resource.data.invitedBy == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );

      // Create: fleet admin only
      allow create: if isAuthenticated() && 
        request.resource.data.invitedBy == request.auth.uid &&
        isFleetAdmin(request.resource.data.fleetId);

      // Update: typically not used (invites are deleted on accept)
      allow update: if isAuthenticated() && 
        resource.data.invitedBy == request.auth.uid;

      // Delete: inviter (cancel) OR invitee (accept/decline)
      allow delete: if isAuthenticated() && (
        resource.data.invitedBy == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );
    }

    // ============================================
    // FAMILY MEMBERSHIPS COLLECTION
    // Fields: id, primaryUserId, memberId, permission, assignedVehicleIds, joinedAt
    // Query patterns:
    // 1. where('primaryUserId', '==', uid) - primary user views members
    // 2. where('memberId', '==', uid) - member views their membership
    // ============================================
    match /familyMemberships/{membershipId} {
      allow read: if isAuthenticated() && (
        resource.data.primaryUserId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      );

      allow create: if isAuthenticated() && (
        request.resource.data.primaryUserId == request.auth.uid ||
        request.resource.data.memberId == request.auth.uid
      );

      allow update: if isAuthenticated() && 
        resource.data.primaryUserId == request.auth.uid &&
        request.resource.data.primaryUserId == resource.data.primaryUserId;

      allow delete: if isAuthenticated() && (
        resource.data.primaryUserId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      );
    }

    // ============================================
    // FAMILY INVITES COLLECTION
    // Fields: id, primaryUserId, email, permission, assignedVehicleIds, createdAt, expiresAt
    // Query patterns:
    // 1. where('email', '==', userEmail) - invitee checks their invites
    // 2. where('primaryUserId', '==', uid) - primary user views sent invites
    // ============================================
    match /familyInvites/{inviteId} {
      // Read: primary user (inviter) OR invitee (matched by email)
      allow read: if isAuthenticated() && (
        resource.data.primaryUserId == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );

      // Create: primary user only
      allow create: if isAuthenticated() && 
        request.resource.data.primaryUserId == request.auth.uid;

      // Update: primary user only
      allow update: if isAuthenticated() && 
        resource.data.primaryUserId == request.auth.uid;

      // Delete: primary user (cancel) OR invitee (accept/decline)
      allow delete: if isAuthenticated() && (
        resource.data.primaryUserId == request.auth.uid ||
        resource.data.email == request.auth.token.email
      );
    }
  }
}
